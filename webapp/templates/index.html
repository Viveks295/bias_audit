<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Essay Bias Audit</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font-Awesome icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  <!-- Tom-Select (multi-select widget) -->
  <link  rel="stylesheet"
         href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<!-- ─────────────────── Top navigation bar ─────────────────── -->
<nav class="bg-white shadow">
  <div class="max-w-7xl mx-auto px-4">
    <div class="flex justify-between h-16">
      <div class="flex items-center gap-3">
        <span class="text-xl font-bold text-blue-600">Essay Bias Audit</span>
      </div>
      <div class="flex items-center gap-6">
        <a href="{{ url_for('index') }}"
           class="text-gray-700 hover:text-blue-600 {% if request.path == '/' %}font-semibold{% endif %}">
          Home
        </a>
        <a href="{{ url_for('about') }}"
           class="text-gray-700 hover:text-blue-600 {% if request.path == '/about' %}font-semibold{% endif %}">
          About
        </a>
      </div>
    </div>
  </div>
</nav>
<!-- ─────────────────────────────────────────────────────────── -->

<div class="flex-grow flex items-center justify-center p-6">
  <div id="main" class="w-full max-w-3xl">

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mb-6 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg">
          <ul class="list-disc list-inside">
            {% for msg in messages %}<li>{{ msg }}</li>{% endfor %}
          </ul>
        </div>
      {% endif %}
    {% endwith %}

    <!-- =========  form (multipart)  =================================== -->
    <form method="post" enctype="multipart/form-data" class="space-y-8">

      <!-- ─────────────── STEP 1 — uploads ─────────────── -->
      <fieldset class="p-6 bg-gray-50 rounded-xl shadow">
        <legend class="text-lg font-semibold flex items-center gap-2">
          <span class="w-6 h-6 flex items-center justify-center rounded-full
                       bg-blue-600 text-white text-sm">1</span>
          Upload
          <button type="button" data-key="step1"
                  class="tooltip-icon text-gray-400 hover:text-blue-600">
            <i class="fas fa-info-circle"></i>
          </button>
        </legend>

        <label class="block text-sm font-medium mt-4" for="csv-in">Data CSV</label>
        <label class="mt-1 flex flex-col items-center justify-center
                      border-2 border-dashed border-gray-300 rounded-lg
                      h-32 cursor-pointer bg-white hover:bg-gray-50">
          <span id="csv-name" class="text-gray-500">
            <i class="fas fa-upload"></i>&nbsp;Drop or click
          </span>
          <input id="csv-in" name="data" type="file"
                 accept=".csv" required class="hidden">
        </label>

        <label class="block text-sm font-medium mt-6" for="model-in">Model script (.py)</label>
        <label class="mt-1 flex flex-col items-center justify-center
                      border-2 border-dashed border-gray-300 rounded-lg
                      h-32 cursor-pointer bg-white hover:bg-gray-50">
          <span id="model-name" class="text-gray-500">
            <i class="fas fa-upload"></i>&nbsp;Drop or click
          </span>
          <input id="model-in" name="model" type="file"
                 accept=".py" required class="hidden">
        </label>
      </fieldset>

      <!-- ─────────────── STEP 2 — configure ─────────────── -->
      <fieldset class="p-6 bg-gray-50 rounded-xl shadow">
        <legend class="text-lg font-semibold flex items-center gap-2">
          <span class="w-6 h-6 flex items-center justify-center rounded-full
                       bg-blue-600 text-white text-sm">2</span>
          Configure audit
          <button type="button" data-key="step2"
                  class="tooltip-icon text-gray-400 hover:text-blue-600">
            <i class="fas fa-info-circle"></i>
          </button>
        </legend>

        <label class="block text-sm font-medium">Variations</label>
        <select id="variation-select" name="variations" multiple
                placeholder="Pick one or more…" class="w-full mt-1">
          {% for v in variations %}
            <option value="{{ v }}">{{ v }}</option>
          {% endfor %}
        </select>

        <div id="magnitudes-container" class="mt-6 space-y-4"></div>
      </fieldset>

      <!-- ─────────────── STEP 3 — preview options ─────────────── -->
      <fieldset class="p-6 bg-gray-50 rounded-xl shadow">
        <legend class="text-lg font-semibold flex items-center gap-2">
          <span class="w-6 h-6 flex items-center justify-center rounded-full
                       bg-blue-600 text-white text-sm">3</span>
          Preview samples
        </legend>

        <p class="text-sm text-gray-600 mb-4">
          Select which variations you’d like to preview and how many perturbed
          essays to show for each.
        </p>

        <div id="preview-options" class="space-y-4"></div>
      </fieldset>

      <!-- ─────────────── STEP 4 — buttons ─────────────── -->
      <div class="flex gap-4 justify-end">
        <button type="submit" formaction="{{ url_for('preview') }}"
                class="bg-purple-600 hover:bg-purple-700 text-white
                       font-semibold py-2 px-4 rounded shadow">
          Preview samples
        </button>

        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white
                       font-semibold py-2 px-4 rounded shadow">
          Run audit
        </button>
      </div>
    </form>
    <!-- =============================================================== -->
  </div>
</div>

<!-- ────────────── Slide-in tooltip sidebar ────────────── -->
<div id="tooltip-overlay"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

<div id="tooltip-sidebar"
     class="fixed inset-y-0 right-0 w-96 bg-white shadow-lg transform
            translate-x-full transition-transform duration-300 z-50 flex flex-col">
  <div class="p-4 flex justify-between items-center border-b border-gray-200">
    <h2 id="tooltip-title" class="text-lg font-bold text-gray-900">Info</h2>
    <button id="tooltip-close-btn"
            class="text-gray-500 hover:text-gray-700 focus:outline-none">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div id="tooltip-content" class="p-4 overflow-y-auto flex-1 text-gray-700"></div>
</div>
<!-- ──────────────────────────────────────────────────────── -->

<!-- ────────────────────── page-level JS ─────────────────── -->
<script>
  /* ——— show chosen file names ——— */
  document.getElementById('csv-in').addEventListener('change', e => {
    document.getElementById('csv-name').textContent =
      e.target.files[0]?.name ?? 'Drop or click';
  });
  document.getElementById('model-in').addEventListener('change', e => {
    document.getElementById('model-name').textContent =
      e.target.files[0]?.name ?? 'Drop or click';
  });

  /* ——— Tom-Select + dynamic inputs ——— */
  const tom = new TomSelect('#variation-select', {
    plugins: ['remove_button'],
    onChange(values) { rebuildAll(values); }
  });

  function rebuildMagnitudes(selected) {
    const box = document.getElementById('magnitudes-container');
    box.innerHTML = '';
    selected.forEach(v => {
      box.insertAdjacentHTML('beforeend', `
        <div>
          <label class="block text-sm font-medium">${v} magnitude (%)</label>
          <input type="number" name="magnitudes" min="0" required
                 class="mt-1 w-full rounded-md border-gray-300 shadow-sm"
                 value="20">
        </div>
      `);
    });
  }

  function rebuildPreviewOptions(selected) {
    const box = document.getElementById('preview-options');
    box.innerHTML = '';
    selected.forEach(v => {
      box.insertAdjacentHTML('beforeend', `
        <label class="flex items-center gap-3">
          <input type="checkbox" name="preview_variations" value="${v}"
                 class="h-4 w-4 mt-[2px]" checked>
          <span class="flex-1">${v}</span>
          <input type="number" name="samples_${v}" value="5" min="1"
                 class="w-20 rounded border-gray-300 shadow-sm">
          <span class="text-sm text-gray-500">samples</span>
        </label>
      `);
    });
  }

  function rebuildAll(selected) {
    rebuildMagnitudes(selected);
    rebuildPreviewOptions(selected);
  }
  rebuildAll([]);  // initial

  /* ——— tooltip sidebar content ——— */
  const tooltipData = {
    step1: {
      title: 'Step 1: Upload',
      content: `
        <p class="mb-4">
          <strong>Data CSV</strong> &nbsp;–&nbsp; must contain two columns:
          <code>prompt</code> and <code>essay</code>. Each row is one prompt /
          response pair.
        </p>
        <p class="mb-4">
          <strong>Model script</strong> &nbsp;–&nbsp; a Python file that defines
          <code>def grade(prompt, essay): …</code>. The audit calls this
          function to obtain the baseline score.
        </p>`
    },
    step2: {
      title: 'Step 2: Configure audit',
      content: `
        <p class="mb-4">
          Select variations to perturb each essay and supply a percentage
          magnitude.
        </p>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li><strong>spelling</strong> – introduce common typos
              (<code>the</code> → <code>teh</code>).</li>
          <li><strong>pio</strong> – swap pronouns
              (<code>he</code> → <code>she</code>).</li>
          <li><strong>cognates</strong> – replace words with cognates.
              <!-- add others here --> </li>
        </ul>
        <p>
          <em>Magnitude %</em> controls how much of the variation is applied.
          For example, 20 % spelling magnitude adds typos to roughly one out of
          every five words.
        </p>`
    }
  };

  const overlay  = document.getElementById('tooltip-overlay');
  const sidebar  = document.getElementById('tooltip-sidebar');
  const titleEl  = document.getElementById('tooltip-title');
  const contentEl= document.getElementById('tooltip-content');
  const closeBtn = document.getElementById('tooltip-close-btn');

  document.querySelectorAll('.tooltip-icon').forEach(icon => {
    icon.addEventListener('click', () => {
      const key  = icon.dataset.key;
      const info = tooltipData[key];
      if (!info) return;
      titleEl.textContent   = info.title;
      contentEl.innerHTML   = info.content;
      overlay.classList.remove('hidden');
      sidebar.classList.remove('translate-x-full');
    });
  });
  function closeSidebar() {
    overlay.classList.add('hidden');
    sidebar.classList.add('translate-x-full');
  }
  overlay.addEventListener('click', closeSidebar);
  closeBtn.addEventListener('click', closeSidebar);
</script>
</body>
</html>

